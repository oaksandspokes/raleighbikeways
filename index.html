<html>
<head>
    <title>Raleigh Bikeways</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@40,400,0,0&icon_names=bedtime_off" />
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.8.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.8.0/mapbox-gl.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <script src="mapbox-gl-directions.js">
    </script>
    <link rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.2/mapbox-gl-directions.css"
        type="text/css" />

    <!-- Flavicon Metadata -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png?v=xQOgA4Byaj">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png?v=xQOgA4Byaj">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png?v=xQOgA4Byaj">
    <link rel="manifest" href="/site.webmanifest?v=xQOgA4Byaj">
    <link rel="mask-icon" href="/safari-pinned-tab.svg?v=xQOgA4Byaj" color="#0b6623">
    <link rel="shortcut icon" href="/favicon.ico?v=xQOgA4Byaj">
    <meta name="msapplication-TileColor" content="#343323">
    <meta name="theme-color" content="#343323">

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-142487885-3"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzSLFiLPIbJ6QpoBcD9DnKucAXkLco_p0&libraries=places"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'UA-142487885-3');
    </script>
</head>

<body>
    <!-- <div id="header">
        <div id="title">Raleigh Bikeways</div>
        <div id="info-icon-container" onclick="document.getElementById('info-box-container').style.display='block'">
            <i class="material-icons md-36 noselect">info</i>
        </div>
    </div> -->
    <div id="loader-container">
        <div class="loader"></div>
        <div class="loader-background"></div>
    </div>
    <div id="follow-location" onclick="toggleFollowLocation()">
        <span id="no-lock-icon" class="material-icons md-36 md-light noselect">my_location</span>
        <span id="follow-location-text">Follow Location</span>
    </div>
    <div id="info-icon-container" onclick="document.getElementById('info-box-container').style.display='block'">
        <i class="material-icons md-36 md-light black-border noselect">info</i>
    </div>
    <div id="style-icon-container" onclick="document.getElementById('map-style-container').style.display='block'">
        <i class="material-icons md-36 md-light black-border noselect">layers</i>
    </div>
    <div id="direction-search-container">
        <div>
          <input class="search-box" id="startSearchBox" type="text" placeholder="Start Location" />
          <span class="top-search-buttons">
            <button class="curr-location-nav search-btn" onclick="setNavOrigin(false)">
                <i class="material-icons md-18 md-dark noselect">my_location</i>
              </button>
              <!-- <button class="clear-btn search-btn" onclick="clearInput('startSearchBox')">&times;</button> -->
          </span>
        </div>
        <div>
          <input class="search-box search-box-last" id="endSearchBox" type="text" placeholder="End Location" />
          <span class="bottom-search-buttons">
            <!-- <button class="clear-btn search-btn" onclick="clearInput('endSearchBox')">&times;</button> -->
            <button class="curr-location-nav search-btn" onclick="setNavOrigin(true)">
                <i class="material-icons md-18 md-dark noselect">my_location</i>
            </button>
          </span>
        </div>
        <span id="routeDetails" style="display: none;">
            <span id="routeLength"></span>
            <span id="routeTime"></span>
            <button class="clear-btn-separate" onclick="clearInput('startSearchBox');clearInput('endSearchBox');">Clear Route</button>
        </span>
        <button id="hide-search-section" onclick="event.stopPropagation(); toggleDirectionSection()">
            <i class=" material-icons md-36 md-dark noselect">chevron_left</i>
        </button>
    </div>
    <div id="show-directions-container">
        <i class=" material-icons md-48 md-light black-border noselect"
            onclick="toggleDirectionSection()">navigation</i>
        <br>
        <span class="black-border">NAV</span>
    </div>
    <div id="info-box-container" class="modal-container" onclick="this.style.display='none'" style="display: none;">
        <div id="info-box" class="modal" onclick="event.stopPropagation()">
            <div>
                <b>Raleigh Bikeways</b>
                <i class=" material-icons md-24 noselect close-button"
                    onclick="document.getElementById('info-box-container').style.display='none'">close</i>
            </div>
            <div>An
                <a href="https://github.com/oaksandspokes/raleighbikeways" target="_blank">open</a> source
                <a href="https://oaksandspokes.com" target="_blank">community</a>
                built bike navigation site built on open data to help you get around on a bike.
            </div>
            <table>
                <tr>
                    <td>
                        <input id="greenway-checkbox" type="checkbox" class="legend-checkbox"
                            onchange="legendToggleGreenwayLayer(this.checked);" checked>Greenways<br>
                    </td>
                    <td>
                        <svg height="10" width="100" class="greenway-legend">
                            <line x1="0" y1="5" x2="100" y2="5" />
                        </svg>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input type="checkbox" class="legend-checkbox" onchange="" name="closed-greenways-layer"
                            disabled style="visibility: hidden;">Closed Greenways<br>
                    </td>
                    <td>
                        <svg height="10" width="100" class="greenway-closed-legend">
                            <line x1="0" y1="5" x2="100" y2="5" />
                        </svg>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input id="greenway-dashed-checkbox" type="checkbox" class="legend-checkbox"
                            onchange="legendToggleGreenwayDashedLayer(this.checked);" checked>Marginal Greenways
                        <i class="material-icons md-18 noselect"
                            onclick="document.getElementById('marginal-greenway-info-container').style.display='block'">info</i>
                    </td>
                    <td>
                        <svg height="10" width="100" class="greenway-legend">
                            <line x1="0" y1="5" x2="20" y2="5" />
                            <line x1="40" y1="5" x2="60" y2="5" />
                            <line x1="80" y1="5" x2="100" y2="5" />
                        </svg>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input id="greenway-detour-checkbox" type="checkbox" class="legend-checkbox"
                            onchange="legendToggleGreenwayDetourLayer(this.checked)" checked />Greenway Detours
                        <i class="material-icons md-18 noselect"
                            onclick="document.getElementById('greenway-detour-info-container').style.display='block'">info</i>
                    </td>
                    <td>
                        <svg height="10" width="100" class="greenway-detour-legend">
                            <line x1="0" y1="5" x2="20" y2="5" />
                            <line x1="40" y1="5" x2="60" y2="5" />
                            <line x1="80" y1="5" x2="100" y2="5" />
                        </svg>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input id="facilities-checkbox" type="checkbox" class="legend-checkbox"
                            onchange="legendToggleFacilitiesLayer(this.checked);" checked>Bike lanes / Sidepaths
                        <i class="material-icons md-18 noselect"
                            onclick="document.getElementById('bike-lane-info-container').style.display='block'">info</i>
                    </td>
                    <td>
                        <svg height="10" width="100" class="existing-legend">
                            <line x1="0" y1="5" x2="100" y2="5" />
                        </svg>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input id="facilities-dashed-checkbox" type="checkbox" class="legend-checkbox"
                            onchange="legendToggleDashedFacilitiesLayer(this.checked);" checked>Recommended Paths
                        <i class="material-icons md-18 noselect"
                            onclick="document.getElementById('recommended-info-container').style.display='block'">info</i>
                    </td>
                    <td>
                        <svg height="10" width="100" class="existing-legend">
                            <line x1="0" y1="5" x2="20" y2="5" />
                            <line x1="40" y1="5" x2="60" y2="5" />
                            <line x1="80" y1="5" x2="100" y2="5" />
                        </svg>
                    </td>
                </tr>
                <!-- TODO: All Programmed sources were throwing an error -->
                <!-- <tr>
                    <td>
                        <input id="programmed-checkbox" type="checkbox" class="legend-checkbox"
                            onchange="legendToggleProgrammedLayer(this.checked)" checked>Planned Bikeways<br>
                    </td>
                    <td>
                        <svg height="10" width="100" class="programmed-legend">
                            <line x1="0" y1="5" x2="100" y2="5" />
                        </svg>
                    </td>
                </tr> -->
                <tr>
                    <td>
                        <input id="citrix-checkbox" type="checkbox" class="legend-checkbox"
                            onchange="legendToggleCitrixLayer(this.checked)" checked>Cardinal Bikeshare Stations
                        <i class="material-icons md-18 noselect"
                            onclick="document.getElementById('citrix-info-container').style.display='block'">info</i>
                    </td>
                    <td>
                        <svg height="24" width="24" class="existing-legend">
                            <circle cx="12" cy="12" r="10" stroke="black" stroke-width="2" fill="red" />
                        </svg>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input id="bike-parking-checkbox" type="checkbox" class="legend-checkbox"
                            onchange="legendToggleBikeParking(this.checked);" checked>Bike Parking<br>
                    </td>
                    <td>
                        <svg height="24" width="24" class="existing-legend">
                            <circle cx="12" cy="12" r="10" stroke="black" stroke-width="2" fill="blue" />
                        </svg>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input id="water-gauge-checkbox" type="checkbox" class="legend-checkbox"
                            onchange="legendToggleWaterGauges(this.checked)">Show All Water Gauges
                        <i class="material-icons md-18 noselect"
                        onclick="document.getElementById('water-gauge-info-container').style.display='block'">info</i>
                    </td>
                    <td>
                        <span class="gaugeMarker_legend gaugeMarker_info">&nbsp;</span><span class="gaugeMarker_warn gaugeMarker_legend">&nbsp;</span><span class="gaugeMarker_legend gaugeMarker_flood">&nbsp;</span>
                    </td>
                </tr>
            </table>
            <div id="feedback-button-container">
                <a href="https://docs.google.com/forms/d/e/1FAIpQLSeROy90gU_08wwKrasKIGHE4b-uOOUdohYK6ClDtKLd4zvQ1Q/viewform?usp=sf_link"
                    target="_blank" class="button">
                    We Love Feedback!
                </a>
            </div>
        </div>
    </div>
    <div id="map"></div>
    <div id="marginal-greenway-info-container" class="modal-container" onclick="this.style.display='none'"
        style="display: none;">
        <div id="marginal-greenway-info" class="modal legend-info" onclick="event.stopPropagation()">
            <i class=" material-icons md-24 noselect close-button"
                onclick="document.getElementById('marginal-greenway-info-container').style.display='none'">close</i>
            <div id="about">
                <div class="legend-info-title">Marginal Greenways</div>
                <span>
                    We have set marginal greenways to be any greenway that is unpaved or less than 7 feet wide.
                </span>
                <br>
                <img src="img/marginal-greenway-1.jpg" width="300" />
                <img src="img/marginal-greenway-2.jpg" width="300" />
            </div>
            <br>
        </div>
    </div>
    <div id="greenway-detour-info-container" class="modal-container" onclick="this.style.display='none'"
        style="display: none;">
        <div id="greenway-detour-info" class="modal legend-info" onclick="event.stopPropagation()">
            <i class=" material-icons md-24 noselect close-button"
                onclick="document.getElementById('greenway-detour-info-container').style.display='none'">close</i>
            <div id="about">
                <div class="legend-info-title">Greenway Detours</div>
                <span>
                    Community recommended ways to avoid greenway closures. These may take you on sidewalks, bike lanes,
                    or calm neighborhoods.
                    Find out more about greenway closures in Raleigh from the <a
                        href="https://raleighnc.gov/home/content/PRecDesignDevelop/Articles/GreenwayRepairs.html"
                        target="_blank">city.</a>
                </span>
                <br>
            </div>
        </div>
    </div>
    <div id="bike-lane-info-container" class="modal-container" onclick="this.style.display='none'"
        style="display: none;">
        <div id="bike-lane-info" class="modal legend-info" onclick="event.stopPropagation()">
            <i class=" material-icons md-24 noselect close-button"
                onclick="document.getElementById('bike-lane-info-container').style.display='none'">close</i>
            <div id="about">
                <div class="legend-info-title">Bike Lanes / Side Paths</div>
                <span>
                    Bike lanes on the road, as well as side paths next to the road
                </span>
                <br>
                <img src="img/sidepath.jpg" width="300" />
            </div>
        </div>
    </div>
    <div id="recommended-info-container" class="modal-container" onclick="this.style.display='none'"
        style="display: none;">
        <div id="recommended-info" class="modal legend-info" onclick="event.stopPropagation()">
            <i class=" material-icons md-24 noselect close-button"
                onclick="document.getElementById('recommended-info-container').style.display='none'">close</i>
            <div id="about">
                <div class="legend-info-title">Recommended Paths</div>
                <span>
                    Roads without dedicated bike infrastructure, but found to be fairly comfortable to bike on.
                    Generally they have a speed limit of 25 mph or less with low traffic volumes.
                </span>
                <br>
            </div>
        </div>
    </div>
    <div id="citrix-info-container" class="modal-container" onclick="this.style.display='none'" style="display: none;">
        <div id="citrix-info" class="modal legend-info" onclick="event.stopPropagation()">
            <i class=" material-icons md-24 noselect close-button"
                onclick="document.getElementById('citrix-info-container').style.display='none'">close</i>
            <div id="about">
                <div class="legend-info-title">Cardinal Bikeshare Stations</div>
                <span>
                    Raleigh's docked bike share programming, including some electric assist bikes! Find out more, including how to rent the bikes, at
                    <a href="https://cardinalbikeshare.com/" target="_blank">cardinalbikeshare.com</a>
                </span>
                <br>
                <img src="img/citrix.jpg" width="500" />
            </div>
            <br>
        </div>
    </div>
    <div id="water-gauge-info-container" class="modal-container" onclick="this.style.display='none'" style="display: none;">
        <div id="water-gauge-info-info" class="modal legend-info" onclick="event.stopPropagation()">
            <i class=" material-icons md-24 noselect close-button"
                onclick="document.getElementById('water-gauge-info-container').style.display='none'">close</i>
            <div id="about">
                <div class="legend-info-title">USGS Water Gauges</div>
                <span>
                    This site pulls real time data from USGS Water Gauges stationed around the Triangle. Any flood gauges that are recording water levels that indicate there may be flooding will always display an icon on the map.
                    You can also select show all water gauges to display all the water gauges that are being checked on the map. The water levels that indicate a flood are based on the USGS/NOAA site descriptions for the gauge.
                    Please always use your best judgement, and never walk or ride through flowing flood waters!
                </span>
                <br>
                <br>
                <img src="img/stream-gauge-walnut-creek.jpg" width="500" />
            </div>
            <br>
        </div>
    </div>
    <div id="map-style-container" class="modal-container" onclick="this.style.display='none'" style="display: none;">
        <div id="map-style-selection" class="modal legend-info" onclick="event.stopPropagation()">
            <i class=" material-icons md-24 noselect close-button"
                onclick="document.getElementById('map-style-container').style.display='none'">close</i>
            <div id="about">
                <div class="legend-info-title">Map Style Selection</div>
                <input onclick="setStyle(this.id)" id="dark-v10" type="radio" name="rtoggle" value="dark"
                    checked="checked" />
                <label for="dark">dark</label>
                <br>
                <input onclick="setStyle(this.id)" id="streets-v11" type="radio" name="rtoggle" value="streets" />
                <label for="streets">streets</label>
                <br>
                <input onclick="setStyle(this.id)" id="light-v10" type="radio" name="rtoggle" value="light" />
                <label for="light">light</label>
                <br>
                <input onclick="setStyle(this.id)" id="outdoors-v11" type="radio" name="rtoggle" value="outdoors" />
                <label for="outdoors">outdoors</label>
                <br>
                <input onclick="setStyle(this.id)" id="satellite-v9" type="radio" name="rtoggle" value="satellite" />
                <label for="satellite">satellite</label>
                <br>
                <br>
                <div><i>Warning: This will clear any entered directions</i></div>
            </div>
        </div>
    </div>
    </div>

</body>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function () {
            navigator.serviceWorker.register('/sw.js').then(function (registration) {
                // Registration was successful
                console.log('ServiceWorker registration successful with scope: ', registration.scope);
            }, function (err) {
                // registration failed :(
                console.warn('ServiceWorker registration failed: ', err);
            });
        });
    }

    sendInitializationLog();

    mapboxgl.accessToken = 'pk.eyJ1Ijoib2Frc2FuZHNwb2tlcyIsImEiOiJjazR1M2Ztc3cwZXl2M21ub3p6eXF3b2txIn0.BNI4-QbP-094byFujTJAuQ'

    const boundingBox = {
        'southwestCorner' : {
            'lat': '35.4472460',
            'lng': '-79.189453'
        },
        'northeastCorner' : {
            'lat': '36.11791',
            'lng': '-78.22265',
        }
    }

    const startSearchBoxId = 'startSearchBox';
    const endSearchBoxId = 'endSearchBox';

    let allWaterGaugesUrl = `https://waterservices.usgs.gov/nwis/iv/?format=json&bBox=${boundingBox.southwestCorner.lng},${boundingBox.southwestCorner.lat},${boundingBox.northeastCorner.lng},${boundingBox.northeastCorner.lat}&siteStatus=all`
    let specificGaugesUrl = 'https://waterservices.usgs.gov/nwis/iv/?format=json&sites={0}&siteStatus=active'

    const colors = {
        CITRIX: '#f9423a',
        PROGRAMMED: '#3498DB',
        GREENWAY: '#28B463',
        GREENWAY_CLOSED: '#CC0000',
        GREENWAY_CLOSED_X: '#FF0000',
        GREENWAY_DETOUR: '#ff6600',
        //EXISTING: '#EEE',
        EXISTING: '#bd35bd',
    }

    const layers = {
        EXISTING_FACILITIES: "existing-bike-facilities-layer",
        GREENWAY: "greenway-layer",
        GREENWAY_DASHED: "greenway-dashed",
        PROGRAMMED: "programmed-bike-facilities-layer",
        PROGRAMMED_DASHED: "programmed-bike-facilities-dashed-layer",
        RALEIGH_EXISTING_DASHED: "existing-bike-facilities-dashed-layer",
        RALEIGH_GREENWAY_CLOSED: "raleigh-greenways-closed-layer",
        RALEIGH_GREENWAY_SYMBOL: "raleigh-greenway-symbol-layer",
        RALEIGH_GREENWAY_NAME: "raleigh-greenway-name-layer",
        CARY_GREENWAY_NAME: "cary-greenway-name-layer",
        GREENWAY_DETOUR: "greenway-detour-layer",
        CARY_BIKES_DASHED: "cary-bikes-dashed-layer",
        CITRIX: 'citrix-cycle-stations-layer',
        DURHAM_FACILITIES_DASHED: 'durham-dashed-facilities-layer',
        MINGO_GREENWAY_NAMES: 'mingo-greenway-names-layer',
        SMITH_GREENWAY_NAMES: 'smith-greenway-names-layer',
        CH_CARR_FACILITIES_DASHED: 'chapel-hill-carrboro-facilities-dashed',
        BIKE_PARKING: "bike-parking-osm",
        WATER_GAUGE: 'water-gauges',
        BROUTER_ROUTE: 'brouter-route-layer',
    }

    const sources = {
        RALEIGH_GREENWAY: "existing-greenways-raleigh",
        CARY_GREENWAY: "cary-greenways",
        GREENWAY_DETOUR: 'greenway-detour',
        CARY_BIKES: "cary-bikes",
        EXISTING_FACILITIES: "existing-bike-facilities",
        PROGRAMMED_FACILITIES: "programmed-bike-facilities",
        CITRIX: "citrix-cycle-stations",
        UMSTEAD: 'umstead-trails',
        DURHAM_SOLID: 'durham-solid',
        DURHAM_DASHED: 'durham-dashed',
        MINGO_GREENWAY: 'mingo-greenway',
        SMITH_GREENWAY: 'smith-greenway',
        CH_CARRBORO: 'chapel-hill-carrboro',
        OSM: 'osm-data',
        USGS_WATER_GAUGES: 'usgs-water-gauges',
        BROUTER_ROUTER: 'brouter-route-source',
    }

    // Custom styling for the direction line
    // Make it see through so user can see the bike infrastructure. 
    const directionsStyling = [{
        'id': 'directions-route-line',
        'type': 'line',
        'source': 'directions',
        'layout': {
            'line-cap': 'butt',
            'line-join': 'round'
        },
        'paint': {
            'line-color': {
                'property': 'congestion',
                'type': 'categorical',
                'default': '#4882c5',
                'stops': [
                    ['unknown', '#4882c5'],
                    ['low', '#4882c5'],
                    ['moderate', '#f09a46'],
                    ['heavy', '#e34341'],
                    ['severe', '#8b2342']
                ]
            },
            'line-width': 7,
            'line-opacity': .5
        },
        'filter': [
            'all',
            ['in', '$type', 'LineString'],
            ['in', 'route', 'selected']
        ]
    }, {
        'id': 'directions-route-line-casing',
        'type': 'line',
        'source': 'directions',
        'layout': {
            'line-cap': 'round',
            'line-join': 'round'
        },
        'paint': {
            'line-color': '#2d5f99',
            'line-width': 12,
            'line-opacity': .5
        },
        'filter': [
            'all',
            ['in', '$type', 'LineString'],
            ['in', 'route', 'selected']
        ]
    }];

    var mapStyle;
    var savedStyle = getCookie("mapStyle");
    if (savedStyle) {
        mapStyle = savedStyle;
        document.getElementById(savedStyle).checked = true;
    } else {
        setCookie("mapStyle", "dark-v10", 1000);
        mapStyle = "dark-v10";
    }

    var lastCameraLng = getCookie("lastCameraLng");
    var lastCameraLat = getCookie("lastCameraLat");
    var lastZoom = getCookie("lastZoom") || 12;
    if (!lastCameraLng || !lastCameraLat) {
        lastCameraLng = "-78.638176";
        lastCameraLat = "35.779591"
        setCookie("lastCameraLng", lastCameraLng, 1000);
        setCookie("lastCameraLat", lastCameraLat, 1000);
    }

    let map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/' + mapStyle,
        center: [lastCameraLng, lastCameraLat],
        zoom: lastZoom
    });

    map.dragRotate.disable(); // we are using right click for something else

    map.on('idle', () => {
        var mapCenter = map.getCenter();
        setCookie("lastCameraLng", mapCenter.lng, 1000);
        setCookie("lastCameraLat", mapCenter.lat, 1000);
        setCookie("lastZoom", map.getZoom(), 1000);
    });

    map.on('error', (message) => {
        onError(`A Mapbox Error has occurred: ${JSON.stringify(message)}`);
    });

    let touchStartTime = null;
    let touchLocation = null;
    map.on('touchstart', (event) => {
        touchStartTime = new Date().getTime();
        touchLocation = event.point;
    });

    map.on('touchend', (event) => {
        const longTouchTimeMS = 500;
        const touchTime = new Date().getTime() - touchStartTime;

        const acceptableMoveDistance = 10;
        const didNotMoveMap = touchLocation && Math.abs(event.point.x - touchLocation.x) < acceptableMoveDistance && Math.abs(event.point.y - touchLocation.y) < acceptableMoveDistance
        if (touchStartTime && ( touchTime > longTouchTimeMS) && didNotMoveMap) {
            console.log("did not move map");
            showContextMenuPopupOnPoint(event.lngLat);
        }

        touchStartTime = null;
        touchLocation = null;
    });

    map.on('contextmenu', event => {
        showContextMenuPopupOnPoint(event.lngLat);
    });

    map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');

    const geolocateControl = new mapboxgl.GeolocateControl({
        positionOptions: {
            enableHighAccuracy: true,
            maximumAge: 5000,
        },
        trackUserLocation: true
    })

    let lastFoundPosition;

    geolocateControl.on('geolocate', (geoPos) => {
        lastFoundPosition = [geoPos.coords.longitude, geoPos.coords.latitude];
    });

    geolocateControl.on('error', (err) => {
        console.warn(err.message);
        if (err.code == 1) {
            window.alert("Geolocation permission was denied, please enable to use")
        }
    });

    map.on('movestart', (event) => {
        // If it was a zoom from a mapbox button, let's keep the following state active
        const fromResize = event.originalEvent && event.originalEvent.currentTarget && event.originalEvent.currentTarget.className && event.originalEvent.currentTarget.className.includes('mapboxgl-ctrl-zoom');
        if (customFollowState === 'ACTIVE' && !fromResize && !event.trackingMove) {
            setTrackingText("Recenter");
            customFollowState = 'BACKGROUND';
        }
    });

    function setGeolocateControl(show) {
        if (show) {
            if (!map.hasControl(geolocateControl)) {
                map.addControl(geolocateControl, 'bottom-right');
            }
        } else {
            if (map.hasControl(geolocateControl)) {
                map.removeControl(geolocateControl);
            }
        }
    }

    setGeolocateControl(true);

    let showingDirections = false;
    let showingDirectionsSection = true;

    let contextMenuPopup = null;
    let startMarker = null;
    let endMarker = null;

    let startLocation = null;
    let endLocation = null;
    let brouterRoute = null;
    let brouterCustomProfile = null;
    let wakeLock = null;
    let wakeLockSupported = false;

    let customFollowState = 'OFF'; // Can be OFF, ACTIVE, BACKGROUND
    let watchID = null; // geolocation watch ID, needs to be cleared when we aren't using it
    let userLocationMarker = null;
    let userRotationHeading = 0;

    if ("wakeLock" in navigator) {
        wakeLockSupported = true;
    }

    // Function to help build a query string for querying the ArcGIS REST service
    function queryString(queryProperties) {
        let queryString = '';
        for (let property in queryProperties) {
            queryString += `${property}=${queryProperties[property].toString()}&`
        }
        return queryString.slice(0, -1)
    }

    // REST endpoint for a dataset published to an ArcGIS Server. In this case, it was published to an ArcGIS Online ArcGIS Server 
    let existingRaleighGreenwaysURL = 'https://services.arcgis.com/v400IkDOw1ad7Yad/ArcGIS/rest/services/Greenway_Trails_All/FeatureServer/0';
    let existingBikeFacilities = 'https://services.arcgis.com/v400IkDOw1ad7Yad/ArcGIS/rest/services/Existing_Bike_Facilities/FeatureServer/6';
    let programmedBikeFacilities = 'https://services.arcgis.com/v400IkDOw1ad7Yad/ArcGIS/rest/services/Programmed_Bike_Facilities/FeatureServer/6';
    let citrixCycleStations = 'https://services.arcgis.com/v400IkDOw1ad7Yad/arcgis/rest/services/Citrix_Cycle_Stations/FeatureServer/0';
    let durhamURL = 'https://webgis.durhamnc.gov/server/rest/services/OpenData/Bike_Facilities/MapServer/0';

    // Create the query string. These are the minimum parameters needed to return valid GeoJSON of a dataset, but addtional parameters could be added to refine the query
    let queryParams = queryString({
        where: "1=1",
        outSR: 4326,
        outFields: "*",
        f: "geojson"
    });

    let citrixQueryParams = queryString({
        where: "status LIKE 'open'",
        outSR: 4326,
        outFields: "*",
        f: "geojson"
    });

    // We split up solid & dashed for durham as otherwise we would be close to the ARCGIS 1000 item limit
    let durhamSolidQueryParams = queryString({
        // We are filtering out Objectid_1 18 - 20 as they are repeats of the American Tobacco Trail
        // and they block the fact that it is not paved
        where: "(Bike_Facil LIKE 'Multiuse Path' OR Bike_Facil LIKE 'Bicycle Lane' OR Bike_Facil LIKE 'Bicycle Lane - One Side') AND (OBJECTID_1 < 18 OR OBJECTID_1 > 20)",
        outSR: 4326,
        outFields: "*",
        f: "geojson"
    });

    // Generate the full query URL
    let existingRaleighGreenwaysQuery = `${existingRaleighGreenwaysURL}/query?${queryParams}`;
    let caryGreenwaysQuery = `data/caryGreenways.geojson`;
    let caryBikeQuery = `data/caryFacilities.geojson`;
    let existingBikeFacilitiesQuery = `${existingBikeFacilities}/query?${queryParams}`;
    let programmedBikeFacilitiesQuery = `${programmedBikeFacilities}/query?${queryParams}`;
    let citrixCycleStationsQuery = `${citrixCycleStations}/query?${citrixQueryParams}`;
    let greenwayDetourQuery = 'https://gist.githubusercontent.com/jonathonwpowell/51172dccc17cf8a832ff6566e700c2d8/raw/map.geojson';
    let durhamDashedQuery = 'data/durham_shared.geojson';
    let chCarrboroQuery = 'https://gist.githubusercontent.com/jonathonwpowell/23679b5c11f8108bc1aecad157475a8f/raw/ch-carrboro-bike-facilities.geojson';
    let osmQuery = 'https://raw.githubusercontent.com/oaksandspokes/bikeOsmExport/master/bikeInfra.geojson';

    let waterGaugeMetadata = null;
    let showAllWaterGauges = false;
    let addedWaterGaugeMarkers = [];


    map.on('style.load', () => {
        onStyleLoad();

        map.resize();
    });

    function onStyleLoad() {
        try {
            addMapSources();

            addMapLayers();

            // After the map has started loading and all the layers have been added
            // we want to disable any layers the user previously removed
            if (getCookie("hasOpened")) {
                if (getCookie("hideGreenway") === "true") {
                    legendToggleGreenwayLayer(false);
                    document.getElementById('greenway-checkbox').checked = false;
                }
                if (getCookie("hideGreenwayDashed") === "true") {
                    legendToggleGreenwayDashedLayer(false);
                    document.getElementById('greenway-dashed-checkbox').checked = false;
                }
                if (getCookie("hideGreenwayDetour") === "true") {
                    legendToggleGreenwayDetourLayer(false);
                    document.getElementById('greenway-detour-checkbox').checked = false;
                }
                if (getCookie("hideFacilities") === "true") {
                    legendToggleFacilitiesLayer(false);
                    document.getElementById('facilities-checkbox').checked = false;
                }
                if (getCookie("hideFacilitiesDashed") === "true") {
                    legendToggleDashedFacilitiesLayer(false);
                    document.getElementById('facilities-dashed-checkbox').checked = false;
                }
                if (getCookie("hideCitrix") === "true") {
                    legendToggleCitrixLayer(false);
                    document.getElementById('citrix-checkbox').checked = false;
                }
                // if (getCookie("hideProgrammed") === "true") {
                //     legendToggleProgrammedLayer(false);
                //     document.getElementById('programmed-checkbox').checked = false;
                // }
                if (getCookie("hideBikeParking") === "true") {
                    legendToggleBikeParking(false);
                    document.getElementById('bike-parking-checkbox').checked = false;
                }
                if (getCookie("showAllWaterGauges") === "true") {
                    showAllWaterGauges = true;
                    document.getElementById('water-gauge-checkbox').checked = true;
                }
                // after reading cookie so we know whether to add the non-flood state water gauges
                handleWaterGauges();

            } else {
                setCookie("hasOpened", "true", 1000);
                // We default the programmed bike infra to not show
                legendToggleProgrammedLayer(false);
                // document.getElementById('programmed-checkbox').checked = false;
            }

            setBrouterRoute(true);
        } catch (e) {
            onException(`Error on map style load`, e);
            alert(`Unknown Error; Please Refresh the Page`);
        }
    }

    function addMapSources() {

        map.addSource(sources.OSM, {
            'type': 'geojson',
            'data': osmQuery,
        })

        map.addSource(sources.CARY_BIKES, {
            'type': 'geojson',
            'data': caryBikeQuery,
        });

        // map.addSource(sources.PROGRAMMED_FACILITIES, {
        //     'type': 'geojson',
        //     'data': programmedBikeFacilitiesQuery
        // });

        map.addSource(sources.RALEIGH_GREENWAY, {
            'type': 'geojson',
            'data': existingRaleighGreenwaysQuery
        });

        map.addSource(sources.GREENWAY_DETOUR, {
            'type': 'geojson',
            'data': greenwayDetourQuery,
        });

        map.addSource(sources.DURHAM_DASHED, {
            'type': 'geojson',
            'data': durhamDashedQuery
        });

        map.addSource(sources.CARY_GREENWAY, {
            'type': 'geojson',
            'data': caryGreenwaysQuery
        });

        // TODO: This was throwing an error
        // map.addSource(sources.EXISTING_FACILITIES, {
        //     'type': 'geojson',
        //     'data': existingBikeFacilitiesQuery
        // });

        map.addSource(sources.CITRIX, {
            'type': 'geojson',
            'data': citrixCycleStationsQuery
        });

        map.addSource(sources.CH_CARRBORO, {
            'type': 'geojson',
            'data': chCarrboroQuery
        });
    }

    function addMapLayers() {

        // TODO: this was throwing an error
        // map.addLayer({
        //     'id': layers.RALEIGH_EXISTING_DASHED,
        //     'type': 'line',
        //     'source': sources.EXISTING_FACILITIES,
        //     'layout': {},
        //     'paint': {
        //         'line-color': colors.EXISTING,
        //         'line-width': 2,
        //         'line-dasharray': [1, 2]
        //     }
        // });

        map.addLayer({
            'id': layers.CARY_BIKES_DASHED,
            'type': 'line',
            'source': sources.CARY_BIKES,
            'layout': {},
            'paint': {
                'line-color': colors.EXISTING,
                'line-width': [
                    "match",
                    ['get', 'FACILTYTYPE'],
                    ['STRIPED', 'PROTECTED BIKE LANES'], 0,
                    1.5
                ],
                'line-opacity': [
                    "match",
                    ['get', 'SPEEDLIMIT'],
                    ["25", "25 MPH"], 1,
                    0
                ],
                'line-dasharray': [1, 2]
            }
        });

        // TODO: this was throwing an error
        // map.addLayer({
        //     'id': layers.PROGRAMMED,
        //     'type': 'line',
        //     'source': sources.PROGRAMMED_FACILITIES,
        //     'layout': {},
        //     'paint': {
        //         'line-color': colors.PROGRAMMED,
        //         'line-width': [
        //             'match',
        //             ['get', 'Type'],
        //             ['Bike Lane', 'Separated Bike Lane', 'Buffered Bike Lane', 'Buffered Bike Lane/Bike Lane', 'Multi-Use Path'], 2,
        //             0
        //         ]
        //     }
        // });

        // map.addLayer({
        //     'id': layers.PROGRAMMED_DASHED,
        //     'type': 'line',
        //     'source': sources.PROGRAMMED_FACILITIES,
        //     'layout': {},
        //     'paint': {
        //         'line-color': colors.PROGRAMMED,
        //         'line-width': 2,
        //         'line-dasharray': [1, 2]
        //     }
        // });

        map.addLayer({
            'id': layers.GREENWAY_DETOUR,
            'type': 'line',
            'source': sources.GREENWAY_DETOUR,
            'layout': {},
            'paint': {
                'line-color': colors.GREENWAY_DETOUR,
                'line-width': 1.5,
                'line-dasharray': [1, 2],
            }
        });

        map.addLayer({
            'id': layers.EXISTING_FACILITIES,
            'type': 'line',
            'source': sources.OSM,
            'layout': {},
            'paint': {
                'line-color': colors.EXISTING,
                'line-width': 2,
                'line-opacity': ['case',
                    ['any',
                        ['match',
                            ['get', 'cycleway'],
                            'lane', true, false],
                        ['match',
                            ['get', 'cycleway:left'],
                            'lane', true, false],
                        ['match',
                            ['get', 'cycleway:right'],
                            'lane', true, false],
                        ['match',
                            ['get', 'cycleway'],
                            'track', true, false],
                        ['match',
                            ['get', 'cycleway:left'],
                            'track', true, false],
                        ['match',
                            ['get', 'cycleway:right'],
                            'track', true, false]
                    ],
                    1,
                    0]
            }
        });

        map.addLayer({
            'id': layers.GREENWAY,
            'type': 'line',
            'source': sources.OSM,
            'layout': {},
            'paint': {
                'line-color': colors.GREENWAY,
                'line-width': 1.5,
                'line-opacity': ['case',
                    ['all',
                        ['any',
                            ['match',
                                ['get', 'highway'],
                                'cycleway', true, false],
                            ['all',
                                ['match',
                                    ['get', 'bicycle'],
                                    'designated', true, false],
                                ['match',
                                    ['get', 'highway'],
                                    'footway', true, false],
                                ['match',
                                    ['get', 'crossing'],
                                    'marked', true, false],
                            ],
                        ],
                        ['match',
                            ['get', 'surface'],
                            ['paved', 'concrete', 'asphalt', 'wood', 'paving_stones'], true, false
                        ],
                    ],
                    1,
                    0
                ],

            }
        });

        map.addLayer({
            'id': layers.GREENWAY_DASHED,
            'type': 'line',
            'source': sources.OSM,
            'layout': {},
            'paint': {
                'line-color': colors.GREENWAY,
                'line-width': 1.5,
                'line-dasharray': [1, 2],
                'line-opacity': ['case',
                    ['all',
                        ['any',
                            ['match',
                                ['get', 'highway'],
                                'cycleway', true, false],
                            ['match',
                                ['get', 'bicycle'],
                                'designated', true, false],
                        ],
                        ['match',
                            ['get', 'surface'],
                            ['paved', 'concrete', 'asphalt', 'wood'], false, true
                        ],
                    ],
                    1,
                    0
                ],

            }
        });

        map.addLayer({
            'id': layers.DURHAM_FACILITIES_DASHED,
            'type': 'line',
            'source': sources.DURHAM_DASHED,
            'layout': {},
            'paint': {
                'line-color': colors.EXISTING,
                'line-width': 1.5,
                'line-dasharray': [1, 2],
            }
        });


        map.addLayer({
            'id': layers.RALEIGH_GREENWAY_CLOSED,
            'type': 'line',
            'source': sources.RALEIGH_GREENWAY,
            'layout': {},
            'paint': {
                'line-color': colors.GREENWAY_CLOSED,
                'line-width': 1.5,
                'line-opacity': [
                    'case',
                    ["match", ["get", "GWSTATUS"], ["CLOSED_TEMP"], true, false],
                    1,
                    0,
                ],
            }
        });

        map.addLayer({
            'id': layers.CH_CARR_FACILITIES_DASHED,
            'type': 'line',
            'source': sources.CH_CARRBORO,
            'layout': {},
            'paint': {
                'line-color': colors.EXISTING,
                'line-width': 1.5,
                'line-opacity': [
                    'match',
                    ['get', 'Bike Facility'],
                    ['Sharrow'], 1,
                    0,
                ],
                'line-dasharray': [1, 2],
            }
        });

        /* ---------------------Add symbol layers last so they are on top----------------------- */
        map.addLayer({
            'id': layers.BIKE_PARKING,
            'type': 'circle',
            'source': sources.OSM,
            'minzoom': 15,
            'layout': {},
            'paint': {
                'circle-color': 'blue',
                'circle-radius': 4,
                'circle-opacity': [
                    'case',
                    ["match", ["get", "amenity"], ["bicycle_parking"], true, false],
                    1,
                    0,
                ],
            }
        });

        map.addLayer({
            'id': layers.CITRIX,
            'type': 'circle',
            'source': sources.CITRIX,
            'minzoom': 11,
            'layout': {},
            'paint': {
                'circle-color': colors.CITRIX,
                'circle-radius': 5,
            }
        });

        map.addLayer({
            'id': layers.RALEIGH_GREENWAY_SYMBOL,
            'type': 'symbol',
            'source': sources.RALEIGH_GREENWAY,
            'layout': {
                'text-field': [
                    'match',
                    ['get', 'GWSTATUS'],
                    "CLOSED_TEMP", "X",
                    ""
                ],
                'symbol-placement': 'line-center',
            },
            'paint': {
                'text-color': colors.GREENWAY_CLOSED_X,
                'text-halo-width': 1,
                'text-halo-color': 'black',
            },
        });

        map.addLayer({
            'id': layers.CARY_GREENWAY_NAME,
            'type': 'symbol',
            'source': sources.CARY_GREENWAY,
            'layout': {
                'text-field': ['get', 'NAME'],
                'symbol-placement': 'line',
                'text-size': 14,
            },
            'paint': {
                'text-color': colors.GREENWAY,
                'text-halo-width': 1,
                'text-halo-color': 'black',
            },
        });

        map.addLayer({
            'id': layers.RALEIGH_GREENWAY_NAME,
            'type': 'symbol',
            'source': sources.RALEIGH_GREENWAY,
            'layout': {
                'text-field': ['get', 'TRAIL_NAME'],
                'symbol-placement': 'line',
                'text-size': 14,
            },
            'paint': {
                'text-color': colors.GREENWAY,
                'text-halo-width': 1,
                'text-halo-color': 'black',
            },
        });
    }

    function addWaterGaugeData() {
        if (!waterGaugeMetadata) {
            onError("The Water Gauge Metadata was not populated");
            return;
        }


        let waterGaugeIds = Object.keys(waterGaugeMetadata);
        let completeUrl = specificGaugesUrl.replace("{0}",waterGaugeIds.join(","));

        fetch(completeUrl, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },
        })
            .then(response => response.json())
            .then(data => {
                const GaugeVariableUSGSID = "45807202";
                const gaugeTimeSeries = data.value.timeSeries.filter(ts => ts.variable.oid === GaugeVariableUSGSID);
                if (gaugeTimeSeries) {
                    const gaugeGeoJSON = USGSToGeoJSON(gaugeTimeSeries);
                    addWaterGaugesToMap(gaugeGeoJSON);
                } else {
                    onError("Gauge data was not part of the USGS data");
                }
                
            })
            .catch(e => {
                onError("error fetching water gauge data", e);
            })
    }

    function addWaterGaugesToMap(geoJson) {
        addedWaterGaugeMarkers.forEach(m => m.remove());
        addedWaterGaugeMarkers = [];

        geoJson.features.forEach(f => {
            const currentUrl = new URL(window.location.href);
            const pretendGaugeHeight = currentUrl.searchParams.get("gaugeHeight");

            // allow for a passed in gauge height for demo purposes
            const actualGaugeHeight = pretendGaugeHeight ? pretendGaugeHeight : f.properties.gaugeHeight;

            const gaugeInfo = waterGaugeMetadata[f.properties.usgsId];
            
            let gaugeClass = "gaugeMarker_info";

            const warnLevel = gaugeInfo.waterHeightMessages["warn"]["level"];
            const floodLevel = gaugeInfo.waterHeightMessages["flood"]["level"];
            let msg = "Current Gauge Height: {0}ft<br>Warning Level: {1}ft<br>Flood Level: {2}ft".replace("{0}", actualGaugeHeight).replace("{1}", warnLevel).replace("{2}", floodLevel);
            if (gaugeInfo) {
                // Get all the defined water height messages that are for water heights less than the current water height,
                //and then sort so that the message for the highest water height is first
                const sortedRelevantLevels = Object.entries(gaugeInfo.waterHeightMessages).filter(e => e[1].level < actualGaugeHeight).sort((e1, e2) => e2[1].level - e1[1].level);
                if (sortedRelevantLevels.length > 0) {
                    const floodMsgType = sortedRelevantLevels[0][0]; // key of the first object maps to "warn" or "flood"

                    gaugeClass = "gaugeMarker_" + floodMsgType
                    if (sortedRelevantLevels[0][1].message) {
                        msg = sortedRelevantLevels[0][1].message;
                    } else {
                        msg = floodMsgType;
                    }
                } else {
                    // There are no messages for the current water height, so no flood warnings
                    // Use the default info class
                }
            }

            const popup = new mapboxgl.Popup({ offset: 25 }).setHTML(
                '<p>USGS Water Gauge: <a href=https://waterdata.usgs.gov/monitoring-location/{0} target="_blank">{0}</a></p>'.replaceAll('{0}', f.properties.usgsId) +
                "<p>" + msg + "</p>"
            );

            if (gaugeClass === "gaugeMarker_info" && showAllWaterGauges === false) {
                // In this state we only want the water gauges where there is some warning
                return;
            }

            const el = document.createElement('div');
            el.id = 'USGS_' + f.properties.usgsId;
            el.className = 'gaugeMarker ' + gaugeClass;

            const newMarker = new mapboxgl.Marker(el)
                .setLngLat(f.geometry.coordinates)
                .setPopup(popup)
                .addTo(map);

            addedWaterGaugeMarkers.push(newMarker);
        });
    }

    function handleWaterGauges() {
        if (!waterGaugeMetadata) {
            fetch("waterGaugeMetadata.json")
                .then(response => response.json())
                .then(json => {
                    waterGaugeMetadata = json;
                    addWaterGaugeData();
                })
                .catch(error => {
                    onException(`Failed to fetch water gauge metadata ${error.message}`, error);
                });
        } else {
            addWaterGaugeData();
        }
    }

    function USGSToGeoJSON(timeSeries) {
        const geoJSON = {
            "type": "FeatureCollection",
            "features": []
        };

        timeSeries.forEach(ts => {
            const gaugeHeight = ts.values[0].value[0].value;
            const lat = ts.sourceInfo.geoLocation.geogLocation.latitude;
            const lng = ts.sourceInfo.geoLocation.geogLocation.longitude;
            const name = ts.sourceInfo.siteName;
            const siteUSGSId = ts.sourceInfo.siteCode.find(sc => sc.agencyCode === "USGS").value;

            const feature = {
                "type": "Feature",
                "geometry": {
                    "type": "Point",
                    "coordinates": [lng, lat]
                },
                "properties": {
                    "name": name,
                    "usgsId": siteUSGSId,
                    "gaugeHeight": gaugeHeight,
                }
            }

            geoJSON.features.push(feature);
        });

        return geoJSON;
    }

    function legendToggleGreenwayLayer(isChecked) {
        var visibilityState = isChecked ? 'visible' : 'none';
        setCookie("hideGreenway", (!isChecked).toString(), 1000);

        setVisibilityProperty(layers.GREENWAY, visibilityState);
        setVisibilityProperty(layers.RALEIGH_GREENWAY_CLOSED, visibilityState);
    }

    function legendToggleGreenwayDashedLayer(isChecked) {
        var visibilityState = isChecked ? 'visible' : 'none';
        setCookie("hideGreenwayDashed", (!isChecked).toString(), 1000);

        setVisibilityProperty(layers.GREENWAY_DASHED, visibilityState);
    }

    function legendToggleGreenwayDetourLayer(isChecked) {
        var visibilityState = isChecked ? 'visible' : 'none';
        setCookie("hideGreenwayDetour", (!isChecked).toString(), 1000);

        setVisibilityProperty(layers.GREENWAY_DETOUR, visibilityState);
    }

    function legendToggleFacilitiesLayer(isChecked) {
        var visibilityState = isChecked ? 'visible' : 'none';
        setCookie("hideFacilities", (!isChecked).toString(), 1000);

        setVisibilityProperty(layers.EXISTING_FACILITIES, visibilityState);
    }

    function legendToggleDashedFacilitiesLayer(isChecked) {
        var visibilityState = isChecked ? 'visible' : 'none';
        setCookie("hideFacilitiesDashed", (!isChecked).toString(), 1000);

        // setVisibilityProperty(layers.RALEIGH_EXISTING_DASHED, visibilityState);
        setVisibilityProperty(layers.CARY_BIKES_DASHED, visibilityState);
        setVisibilityProperty(layers.DURHAM_FACILITIES_DASHED, visibilityState);
        setVisibilityProperty(layers.CH_CARR_FACILITIES_DASHED, visibilityState);
    }

    function legendToggleProgrammedLayer(isChecked) {
        // TODO: all programmed layers were throwing an error

        // var visibilityState = isChecked ? 'visible' : 'none';
        // setCookie("hideProgrammed", (!isChecked).toString(), 1000);

        // setVisibilityProperty(layers.PROGRAMMED, visibilityState);
        // setVisibilityProperty(layers.PROGRAMMED_DASHED, visibilityState);
    }

    function legendToggleCitrixLayer(isChecked) {
        var visibilityState = isChecked ? 'visible' : 'none';
        setCookie("hideCitrix", (!isChecked).toString(), 1000);

        setVisibilityProperty(layers.CITRIX, visibilityState);
    }

    function legendToggleBikeParking(isChecked) {
        var visibilityState = isChecked ? 'visible' : 'none';
        setCookie("hideBikeParking", (!isChecked).toString(), 1000);

        setVisibilityProperty(layers.BIKE_PARKING, visibilityState);
    }

    function legendToggleWaterGauges(isChecked) {
        showAllWaterGauges = isChecked;
        setCookie("showAllWaterGauges", (isChecked).toString(), 1000);

        // re-fetch all data as well
        handleWaterGauges();
    }

    function setVisibilityProperty(layer, isVisible) {
        map.setLayoutProperty(layer, 'visibility', isVisible);
    }

    function setStyle(layerId) {
        var currentStyle = getCookie("mapStyle");
        if (layerId === currentStyle) return;

        setCookie("mapStyle", layerId, 1000);
        map.setStyle('mapbox://styles/mapbox/' + layerId);
    }

    function toggleDirectionSection() {
        if (showingDirectionsSection) {
            document.getElementById('direction-search-container').style.display = 'none';
            document.getElementById('show-directions-container').style.display = 'block';
            showingDirectionsSection = false;
        } else {
            document.getElementById('direction-search-container').style.display = 'block';
            document.getElementById('show-directions-container').style.display = 'none';
            showingDirectionsSection = true;
        }
    }

    function setNavOrigin(setFinish) {
        var options = {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 1000,
        };
        toggleLoader(true);
        navigator.geolocation.getCurrentPosition(
            (geoPos) => {
                toggleLoader(false);
                if (setFinish) {
                    setEndLocationLngLat(geoPos.coords.longitude, geoPos.coords.latitude);
                } else {
                    setStartLocationLngLat(geoPos.coords.longitude, geoPos.coords.latitude);
                }

            },
            (err) => {
                toggleLoader(false);
                console.warn("Error finding position: " + err.message);
                if (lastFoundPosition) {
                    setStartLocationLngLat(lastFoundPosition[0],lastFoundPosition[1])
                };
                if (err.code == 1) {
                    window.alert("Access to the devices location was blocked, please enable to use location services.")
                };
            }, options);
    }

    function setCookie(name, value, days) {
        var expires = "";
        if (days) {
            var date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "") + expires + "; path=/";
    }

    function getCookie(name) {
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    // Initialize autocomplete fields
    function initAutocomplete() {
      const input1 = document.getElementById(startSearchBoxId);
      const input2 = document.getElementById(endSearchBoxId);

      const bounds = new google.maps.LatLngBounds(
        new google.maps.LatLng(boundingBox.southwestCorner.lat, boundingBox.southwestCorner.lng),
        new google.maps.LatLng(boundingBox.northeastCorner.lat, boundingBox.northeastCorner.lng)
      );

      // https://developers.google.com/maps/documentation/javascript/place-autocomplete#constraining-autocomplete
      const autocompleteOptions = {
        bounds: bounds,
        componentRestrictions: { country: "us" },
        fields: ["geometry"],
        strictBounds: false,
      };

      const autocomplete1 = new google.maps.places.Autocomplete(input1, autocompleteOptions);
      const autocomplete2 = new google.maps.places.Autocomplete(input2, autocompleteOptions);

      // Listen for place changes
      autocomplete1.addListener('place_changed', () => handlePlaceChange(autocomplete1, startSearchBoxId));
      autocomplete2.addListener('place_changed', () => handlePlaceChange(autocomplete2, endSearchBoxId));
    }

    function handlePlaceChange(autocomplete, inputId) {
      const place = autocomplete.getPlace();
      if (!place.geometry) {
        console.warn(`No details available for input: ${inputId}`);
        return;
      }

      const location = {
        lat: place.geometry.location.lat(),
        lng: place.geometry.location.lng(),
      };

      if (inputId === startSearchBoxId) {
        setStartLocation(location, false);
      } else if (inputId === endSearchBoxId) {
        setEndLocation(location, false);
      }
    }

    function setStartLocation(location, setLatLongText) {
        startLocation = location;

        const searchBox = document.getElementById(startSearchBoxId);
        if (searchBox.value === '' || setLatLongText) {
            searchBox.value = `${location.lng.toString().slice(0,8)}, ${location.lat.toString().slice(0,8)}`;
        }

        if (startMarker) {
            startMarker.remove();
        }

        startMarker = new mapboxgl.Marker({color: 'green'})
            .setLngLat(startLocation)
            .addTo(map)
        
        if (startLocation && endLocation) {
            fetchRouteFromBRouter(startLocation, endLocation);
        }
    }

    function setStartLocationLngLat(lng, lat) {
        setStartLocation({'lng': lng, 'lat': lat}, true);
    }

    function setEndLocation(location, setLatLongText) {
        endLocation = location;

        const searchBox = document.getElementById(endSearchBoxId);
        if (searchBox.value === '' || setLatLongText) {
            searchBox.value = `${location.lng.toString().slice(0,8)}, ${location.lat.toString().slice(0,8)}`;
        }

        if (endMarker) {
            endMarker.remove();
        }

        endMarker = new mapboxgl.Marker({color: 'red'})
            .setLngLat(endLocation)
            .addTo(map)
        
        if (startLocation && endLocation) {
            fetchRouteFromBRouter(startLocation, endLocation);
        }
    }

    function setEndLocationLngLat(lng, lat) {
        setEndLocation({'lng': lng, 'lat': lat}, true);
    }

    function clearInput(inputId) {
      const input = document.getElementById(inputId);
      input.value = '';

      if (inputId === startSearchBoxId) {
        startLocation = null;
        if (startMarker) {
            startMarker.remove();
        }
      } else if (inputId === endSearchBoxId) {
        endLocation = null;
        if (endMarker) {
            endMarker.remove();
        }
      }
      brouterRoute = null;
      setBrouterRoute();
    }

    async function fetchRouteFromBRouter(loc1, loc2) {
      try {
        toggleLoader(true);
        const profileName = await setBrouterProfile();
        if (!profileName) {
            throw new Error(`No profile to use for navigation`);
        }

        const brouterUrl = `https://brouter.de/brouter?lonlats=${loc1.lng},${loc1.lat}|${loc2.lng},${loc2.lat}&profile=${profileName}&alternativeidx=0&format=geojson`;

        const response = await fetch(brouterUrl);
        if (!response.ok) {
          throw new Error(`Error response from BRouter get route call: ${response.statusText}`);
          return;
        }

        const geojson = await response.json();
        handleGeoJsonResponse(geojson);
      } catch (error) {
        brouterCustomProfile = null; // clear the profile so we re-upload, in case the profile is gone / bugged
        onException('Error fetching route:', error);
        alert(`There was an error fetching the recommended route. You can move the start or end location to retry. Please let us know if this keeps happening`);
      } finally {
        toggleLoader(false);
      }
    }

    async function setBrouterProfile() {
        const brouterProfileUrl = `https://brouter.de/brouter/profile`;

        if (!brouterCustomProfile) {
            try {
                const getProfileFileResponse = await fetch('/brouter-profiles/standard.brf');
                
                if (!getProfileFileResponse.ok) {
                    throw new Error(`Failed to fetch profile file: ${getProfileFileResponse.statusText}`);
                }

                const profileFileData = await getProfileFileResponse.text();

                const setProfileResponse = await fetch(brouterProfileUrl, {
                    method: 'POST',
                    body: profileFileData,
                });

                if (!setProfileResponse.ok) {
                    throw new Error(`Failed to upload profile: ${setProfileResponse.statusText}`);
                }

                const profileResponseJson = await setProfileResponse.json();
                brouterCustomProfile = profileResponseJson.profileid;
            } catch (error) {
                onException('Error uploading profile:', error);
                brouterCustomProfile = null;
            }
        }

        return brouterCustomProfile;
    }

    function showContextMenuPopupOnPoint(coordinates) {
        closeContextMenuPopup();

        const popupHtml = `
        <div id="context-menu-popup" onClick=closeContextMenuPopup()>
            <p onClick=setStartLocationLngLat(${coordinates.lng},${coordinates.lat})>Set Location as Start</p>
            <hr>
            <p onClick=setEndLocationLngLat(${coordinates.lng},${coordinates.lat})>Set Location as End</p>
        </div>
        `

        contextMenuPopup = new mapboxgl.Popup()
            .setLngLat(coordinates)
            .setHTML(popupHtml)
            .addTo(map);
    }

    function closeContextMenuPopup() {
        if (contextMenuPopup) {
            contextMenuPopup.remove();
            contextMenuPopup = null;
        }
    }

    function setRouteDetails() {
        var routeDetails = document.getElementById('routeDetails');
        var routeLength = document.getElementById('routeLength');
        var routeTime = document.getElementById('routeTime');

        if(brouterRoute) {
            routeDetails.style.display = 'block';
            var routeProperties = brouterRoute.features[0].properties;

            routeTime.textContent = round(routeProperties["total-time"] / 60, 0) + " Minutes";
            routeLength.textContent = round((routeProperties["track-length"] * 0.000621371192), 1) + " Miles";
        } else {
            routeDetails.style.display = 'none';
        }
    }

    function handleGeoJsonResponse(geojson) {
        brouterRoute = geojson;
        setBrouterRoute();
    }

    function setBrouterRoute(skipMapMove) {
        removeLayer(layers.BROUTER_ROUTE);
        removeSource(sources.BROUTER_ROUTER);
        setLocationTrackingStyle();
        setRouteDetails()

        if (brouterRoute) {
            if (!skipMapMove) {
                var bounds = new mapboxgl.LngLatBounds();

                brouterRoute.features.forEach(function(feature) {
                    feature.geometry.coordinates.forEach(function(coord) {
                        bounds.extend(coord);
                    });
                });

                map.fitBounds(bounds, { padding: {top: 120, bottom: 40, left: 40, right: 40} });
            }

            map.addSource(sources.BROUTER_ROUTER, {
            'type': 'geojson',
            'data': brouterRoute
            });

            map.addLayer({
                'id': layers.BROUTER_ROUTE,
                'type': 'line',
                'source': sources.BROUTER_ROUTER,
                'layout': {
                    'line-join': 'round',
                    'line-cap': 'round',
                },
                'paint': {
                    'line-color': '#2c7bc9',
                    'line-width': 10,
                    'line-opacity': 0.75
                }
            });
        }
    }

    function allowCustomFollow() {
        return new URLSearchParams(window.location.search).has('customTracking');
    }

    // Use the custom location button if we have a route, otherwise use the default button
    function setLocationTrackingStyle() {
        // We are gating the custom follow stuff behind a URL param as it needs more tuning
        if (!allowCustomFollow()) {
            document.getElementById('follow-location').style.display = 'none'; 
            return;
        }

        const useCustomTrackingStyle = brouterRoute ? true : false;

        if (!useCustomTrackingStyle) {
            setCustomFollowOff();
        }

        if (document.getElementsByClassName('mapboxgl-ctrl-geolocate')[0]) {
            document.getElementsByClassName('mapboxgl-ctrl-geolocate')[0].style.display = useCustomTrackingStyle ? 'none' : 'block';
        }
        document.getElementById('follow-location').style.display = useCustomTrackingStyle ? 'block' : 'none'; 
    }

    function removeLayer(id) {
        if (map.getLayer(id)) {
            map.removeLayer(id);
        }
    }

    function removeSource(id) {
        if (map.getSource(id)) {
            map.removeSource(id);
        }
    }

    function toggleLoader(showLoader) {
        const loaderContainer = document.getElementById('loader-container');
        const displayValue = showLoader ? 'block' : 'none';

        loaderContainer.style.display = displayValue;
    }

    async function toggleFollowLocation() {
        try {
            switch (customFollowState) {
                case 'OFF':
                    setCustomFollowOn();
                    break;
                case 'BACKGROUND':
                    customFollowState = 'ACTIVE';
                    moveOnPositionUpdate(lastFoundPosition[0],lastFoundPosition[1]);
                    setTrackingText("Stop Following")
                    break;
                case 'ACTIVE':
                    setCustomFollowOff();
                    break;
                default:
                    onError('Unexpected custom follow location state: ' + customFollowState);
            }
        } catch(e) {
            onException("Error togging follow location", e);
        }
    }

    function setCustomFollowOn() {
        if (!allowCustomFollow()) {
            return;
        }

        setGeolocateControl(false);
        watchID = navigator.geolocation.watchPosition((position) => {
            lastFoundPosition = [position.coords.longitude, position.coords.latitude];
            moveOnPositionUpdate(position.coords.longitude, position.coords.latitude);
        }, () => {},{
            enableHighAccuracy: true,
            maximumAge: 1000,
        });
        addDeviceOrientationListener();
        toggleWakeLock(true);
        customFollowState = 'ACTIVE';
        setTrackingText("Stop Following");
    }

    function addDeviceOrientationListener() {
        const addListener = () => {
            if ('ondeviceorientationabsolute' in window) {
                window.addEventListener('deviceorientationabsolute', onDeviceOrientation);
            } else {
                // safari is special
                window.addEventListener('deviceorientation', onDeviceOrientation);
            }
        };

        // safari needs permission in some cases
        if (typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission()
                .then(response => {
                    if (response === 'granted') {
                        addListener();
                    }
                })
                .catch(onError);
        } else {
            addListener();
        }
    }

     // If time between updates is too short, it will lock the screen from inputs
    const updateMapOrientationThrottled = throttle(updateMapOrientation,500);

    function onDeviceOrientation(deviceOrientationEvent) {
        let heading;
        if (deviceOrientationEvent.webkitCompassHeading) {
            // Safari
            heading = deviceOrientationEvent.webkitCompassHeading;
        } else if (deviceOrientationEvent.absolute === true) {
            // non-Safari alpha increases counter clockwise around the z axis
            heading = deviceOrientationEvent.alpha * -1;
        }
        userRotationHeading = heading;
        updateMapOrientationThrottled();
    }

    function throttle(fn, time) {
        let pending = false;
        let timerId = null;

        const later = () => {
            timerId = null;
            if (pending) {
                fn();
                timerId = setTimeout(later, time);
                pending = false;
            }
        };

        return () => {
            pending = true;
            if (!timerId) {
                later();
            }
            return timerId;
        };
    }

    function updateMapOrientation() {
        const heading = userRotationHeading;
        if (heading && userLocationMarker) {
            userLocationMarker.setRotation(heading);

            if (customFollowState === 'ACTIVE') {
                map.jumpTo({bearing: heading}, {trackingMove: true});
            }
        }
    }

    function moveOnPositionUpdate(lng, lat) {
        if (lng && lat) {
            if (customFollowState === 'ACTIVE') {
                map.jumpTo({center: [lng, lat]}, {trackingMove: true});
            }
            if (!userLocationMarker) {
                const el = document.createElement('div');
                el.className = 'custom-follow-icon';

                userLocationMarker = new mapboxgl.Marker({
                    element: el,
                    // color: 'purple',
                    rotationAlignment: 'map',
                    pitchAlignment: 'map'
                });
            }
            userLocationMarker.setLngLat([lng, lat]).addTo(map);
            // userLocationMarker.setRotation(userRotationHeading);
        } else {
            userLocationMarker.remove();
        }
        
    }

    function setCustomFollowOff() {
        navigator.geolocation.clearWatch(watchID);
        window.removeEventListener('deviceorientation', this._onDeviceOrientation);
        window.removeEventListener('deviceorientationabsolute', this._onDeviceOrientation);
        toggleWakeLock(false);
        userLocationMarker && userLocationMarker.remove();
        setGeolocateControl(true);
        customFollowState = 'OFF';
        setTrackingText("Follow Location");
    }

    async function toggleWakeLock(shouldFollow) {
        if (!!shouldFollow == !!wakeLock) {
            // We are already in the desired state
            console.log('already at correct wake lock status');
            return;
        }

        if (!wakeLockSupported) {
            onError("tried to get wakelock on unsupported device");
            return;
        }

        // Try and start location tracking

        if (!wakeLock) {
            try {
                wakeLock = await navigator.wakeLock.request("screen");
                document.getElementById("no-lock-icon").style.color = 'cyan'; // TODO: improve this
                console.log("got wake lock");
            } catch (err) {
                // The Wake Lock request has failed - usually system related, such as battery.
                onError(`failed to get wake lock: ${err.name}, ${err.message}`);
            }
        } else {
            wakeLock.release().then(() => {
                wakeLock = null;
                document.getElementById("no-lock-icon").style.color = 'white';
                console.log("released wake lock");
            })
        }
    }

    function setTrackingText(text) {
        document.getElementById('follow-location-text').textContent = text;
    }

    // If the wakelock is asked for, the user goes to another tab, then comes back, this will keep it active
    document.addEventListener("visibilitychange", async () => {
        if (wakeLock !== null && document.visibilityState === "visible") {
            wakeLock = await navigator.wakeLock.request("screen");
        }
    });

    function onException(message, exception) {
        console.error(`[Triangle Bikeways] ${message} | ${exception && exception.message}`, exception);
        sendErrorLog(message, exception);
    }

    function onError(message) {
        console.error(`[Triangle Bikeways] ${message}`);
        sendErrorLog(message, "N/A");
    }

    function getUserToken() {
        let userToken = getCookie("mapUserToken");
        if(!userToken) {
            userToken = Math.floor(Math.random() * 10000000);
            setCookie("mapUserToken",userToken,1000);
        }
        return userToken;
    }

    function sendInitializationLog() {
        const data = {
            level: "INFO",
            message: 'User initialized the map page'
        }
        sendLog(data);
    }

    function sendErrorLog(message, exception) {
        const data = {
            level: "SEVERE",
            message,
            exceptionMessage: JSON.stringify(exception && exception.message),
            exceptionStack: JSON.stringify(exception && exception.stack),
        }

        sendLog(data);
    }

    function sendLog(data) {
        try {
            data.userToken = getUserToken();
            data.currentUrl = window.location.href;

            const logUrl = `https://host1.rapidpossum.xyz:5080/api/trianglebikeways/map/_json`
            fetch(logUrl, {
                    method: 'POST',
                    body: JSON.stringify([data]),
                    headers: { 'Content-Type': 'application/json',
                    'accept': 'application/json',
                    "Authorization": "Basic YWRtaW5AanB0ZXN0LmNvbTpLcTlMd1o1OEJvQVh5ZDFl"
                    },
                }).catch(console.error);
            
            // TODO: Send to logs when we have a https server
        } catch(e) {
            console.error('Error sending logs', e);
        }
    }

    function round(value, precision) {
        var multiplier = Math.pow(10, precision || 0);
        return Math.round(value * multiplier) / multiplier;
    }

    // Load the autocomplete functionality once the script loads
    window.onload = initAutocomplete;
</script>

</html>